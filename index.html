<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tạo thông điệp gửi Đại hội XIV</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Roboto:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <style>
    body { background-color: #f4f7f9; font-family: 'Roboto', sans-serif; }
    .container-fluid { max-width: 1400px; padding-top: 20px; }
    .card-control { border: none; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); background: #fff; height: 100%; }
    .header-box { background: linear-gradient(to right, #d32f2f, #ff5252); color: white; padding: 15px; border-radius: 12px 12px 0 0; text-align: center; font-weight: bold; text-transform: uppercase; }
    .group-label { font-size: 0.9rem; font-weight: 700; color: #d63384; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .label-sm { font-size: 0.85rem; font-weight: 600; color: #333; margin-bottom: 4px; display: block;}
    input[type=range] { -webkit-appearance: none; width: 100%; height: 8px; background: #e0e0e0; border-radius: 5px; outline: none; margin-bottom: 15px; cursor: pointer; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; border-radius: 50%; background: #d32f2f; box-shadow: 0 0 4px rgba(0,0,0,0.3); transition: transform 0.1s; }
    canvas { display: none; }
    #previewImg { width: 100%; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: block; margin: 0 auto; max-height: 80vh; object-fit: contain; }
    .btn-save { background-color: #d32f2f; color: white; font-weight: bold; padding: 14px; border-radius: 8px; width: 100%; border: none; margin-top: 15px; font-size: 1.1rem; }
    .stats-mini { position: fixed; bottom: 20px; right: 20px; background: white; padding: 12px 18px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1000; border: 2px solid #d32f2f; display: flex; align-items: center; gap: 10px; transition: all 0.3s; }
    .stats-mini b { color: #d32f2f; font-size: 1.2rem; }
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: #fff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner-border text-danger" role="status"></div>
  <p class="mt-2 fw-bold text-danger">Đang tải phôi ảnh Đại Hội...</p>
</div>

<div class="stats-mini" id="statsContainer">
  <i class="bi bi-megaphone-fill text-danger fs-5"></i>
  <span>Đã có <b id="userCount">0</b> lượt tạo thông điệp</span>
</div>

<div class="container-fluid mb-5">
  <div class="row h-100">
    <div class="col-lg-4 mb-4">
      <div class="card-control">
        <div class="header-box"><i class="bi bi-pencil-square"></i> Tạo thông điệp Đại hội</div>
        <div class="p-4 overflow-auto" style="max-height: 85vh;">
          <div class="mb-4">
             <div class="group-label">1. Nhập thông tin</div>
             <input class="form-control mb-3" type="file" id="uploadAvatar" accept="image/*">
             <input type="text" class="form-control mb-2" id="inpName" placeholder="Họ và tên (In hoa)">
             <input type="text" class="form-control mb-2" id="inpUnit" placeholder="Chức vụ / Đơn vị">
             <input type="text" class="form-control mb-2" id="inpLoc" placeholder="Xã/Phường - Tỉnh/Thành phố">
             <textarea class="form-control" id="inpMessage" rows="5" placeholder="Thông điệp cá nhân..."></textarea>
          </div>
          <div class="mb-4 bg-light p-3 rounded border">
             <div class="group-label text-primary">2. Căn chỉnh ảnh cá nhân</div>
             <label class="label-sm">Trái / Phải:</label><input type="range" id="avtX" min="-400" max="400" value="0">
             <label class="label-sm">Lên / Xuống:</label><input type="range" id="avtY" min="-400" max="400" value="0">
             <label class="label-sm">Kích thước:</label><input type="range" id="avtScale" min="0.1" max="3.0" step="0.05" value="1.0">
          </div>
          <div class="mb-4 bg-light p-3 rounded border">
             <div class="group-label text-danger">3. Căn chỉnh Tên/Đơn vị/Địa phương</div>
             <label class="label-sm">Di chuyển dọc:</label><input type="range" id="textY" min="-200" max="200" value="0">
             <label class="label-sm">Cỡ chữ Đơn vị/Địa phương:</label><input type="range" id="unitSize" min="10" max="40" value="21">
          </div>
          <div class="mb-3 bg-light p-3 rounded border">
             <div class="group-label text-success">4. Căn chỉnh Thông điệp </div>
             <label class="label-sm">Lên / Xuống:</label><input type="range" id="msgY" min="-200" max="200" value="0">
             <label class="label-sm">Cỡ chữ:</label><input type="range" id="msgSize" min="20" max="70" value="30">
             <label class="label-sm">Độ rộng khung:</label><input type="range" id="msgWidth" min="300" max="1500" value="730">
          </div>
          <button onclick="downloadImage()" class="btn-save shadow"><i class="bi bi-download"></i> TẢI ẢNH KẾT QUẢ</button>
        </div>
      </div>
    </div>
    <div class="col-lg-8 text-center">
       <h6 class="text-danger fw-bold mb-3" style="font-size: 0.9rem;">
         <i class="bi bi-heart-fill me-1"></i> Gửi thông điệp đến Đại hội đại biểu toàn quốc lần thứ XIV của Đảng
       </h6>
       <img id="previewImg" src="">
       <canvas id="myCanvas"></canvas>
    </div>
  </div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw4WbJVmN875SAOzFRMX8kb39FE8wXVwqeGheKWGfvHSgEqYY7YN0jLQzZYCjX2XX3L/exec"; 
  const DRIVE_ID = "1i30MYF682b8hZvTh7hzVSPQ4lHFdvzn3";
  const BACKGROUND_URL = "https://lh3.googleusercontent.com/d/" + DRIVE_ID;
  
  const BASE = {
    avatar: { x: 476, y: 440 }, 
    name:   { x: 365, y: 720, color: "#ffff00", font: "bold 26px Roboto" }, 
    unit:   { x: 365, color: "#ffffff" }, 
    loc:    { x: 365, color: "#ffffff" }, 
    msg:    { x: 770, y: 350, color: "#002a5c", fontFace: "Dancing Script" } 
  };

  const canvas = document.getElementById('myCanvas');
  const ctx = canvas.getContext('2d');
  const previewImg = document.getElementById('previewImg');
  let bgImage = new Image();
  bgImage.crossOrigin = "Anonymous"; 
  let userAvatar = new Image();
  let isAvatarLoaded = false;

  async function loadStats() {
    try {
      const res = await fetch(SCRIPT_URL);
      const count = await res.text();
      document.getElementById('userCount').innerText = isNaN(parseInt(count)) ? "100" : parseInt(count).toLocaleString();
    } catch(e) { document.getElementById('userCount').innerText = "100"; }
  }

  async function incrementStats() {
    try {
      let currentUI = parseInt(document.getElementById('userCount').innerText.replace(/,/g, ''));
      document.getElementById('userCount').innerText = (currentUI + 1).toLocaleString();
      await fetch(SCRIPT_URL + "?action=increment", { mode: 'no-cors' });
    } catch(e) { console.log(e); }
  }

  loadStats();

  bgImage.onload = () => {
    canvas.width = bgImage.width; canvas.height = bgImage.height;
    drawCanvas();
    document.getElementById('loading').style.display = 'none';
  };
  bgImage.src = BACKGROUND_URL;

  document.querySelectorAll('input, textarea').forEach(el => el.addEventListener('input', drawCanvas));

  document.getElementById('uploadAvatar').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      userAvatar = new Image();
      userAvatar.onload = () => { isAvatarLoaded = true; drawCanvas(); };
      userAvatar.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });

  function drawCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (isAvatarLoaded) {
      ctx.save();
      const avtX = parseInt(document.getElementById('avtX').value);
      const avtY = parseInt(document.getElementById('avtY').value);
      const scale = parseFloat(document.getElementById('avtScale').value);
      const baseSize = 420; 
      const ratio = Math.max(baseSize / userAvatar.width, baseSize / userAvatar.height) * scale;
      const w = userAvatar.width * ratio; const h = userAvatar.height * ratio;
      ctx.drawImage(userAvatar, BASE.avatar.x + avtX - w/2, BASE.avatar.y + avtY - h/2, w, h);
      ctx.restore();
    }
    if (bgImage.complete) { ctx.drawImage(bgImage, 0, 0); }
    drawTextOverlay();
    previewImg.src = canvas.toDataURL('image/jpeg', 0.9);
  }

  function drawTextOverlay() {
    const name = (document.getElementById('inpName').value || "").toUpperCase();
    const unit = document.getElementById('inpUnit').value || "";
    const loc = document.getElementById('inpLoc').value || "";
    const msg = document.getElementById('inpMessage').value || "";
    
    const textY = parseInt(document.getElementById('textY').value);
    const unitSize = parseInt(document.getElementById('unitSize').value);
    const msgY = parseInt(document.getElementById('msgY').value);
    const msgSize = parseInt(document.getElementById('msgSize').value);
    const msgWidth = parseInt(document.getElementById('msgWidth').value);

    // Vẽ tên/đơn vị căn giữa
    ctx.textAlign = "center";
    ctx.fillStyle = BASE.name.color; ctx.font = BASE.name.font; 
    ctx.fillText(name, BASE.name.x, BASE.name.y + textY);

    const unitY = BASE.name.y + textY + 32;
    ctx.fillStyle = BASE.unit.color; ctx.font = `italic ${unitSize}px Roboto`;
    ctx.fillText(unit, BASE.unit.x, unitY);

    const locY = unitY + unitSize + 5;
    ctx.fillStyle = BASE.loc.color; ctx.font = `italic ${unitSize}px Roboto`;
    ctx.fillText(loc, BASE.loc.x, locY);

    // Vẽ thông điệp CĂN ĐỀU (JUSTIFY)
    ctx.textAlign = "left"; 
    ctx.fillStyle = BASE.msg.color; 
    ctx.font = `${msgSize}px "${BASE.msg.fontFace}"`; 
    
    // Gọi hàm căn đều
    justifyText(ctx, msg, BASE.msg.x, BASE.msg.y + msgY, msgWidth, msgSize * 1.5);
  }

  // HÀM QUAN TRỌNG: Vẽ văn bản căn đều hai bên như Word
  function justifyText(context, text, x, y, maxWidth, lineHeight) {
    const words = text.split(' ');
    let lines = [];
    let currentLine = [];

    // Chia văn bản thành các dòng
    words.forEach(word => {
      let testLine = [...currentLine, word].join(' ');
      if (context.measureText(testLine).width > maxWidth && currentLine.length > 0) {
        lines.push(currentLine);
        currentLine = [word];
      } else {
        currentLine.push(word);
      }
    });
    lines.push(currentLine); // Dòng cuối cùng

    lines.forEach((lineWords, index) => {
      const isLastLine = index === lines.length - 1;
      const lineText = lineWords.join(' ');
      
      // Nếu là dòng cuối hoặc chỉ có 1 từ: Căn trái bình thường
      if (isLastLine || lineWords.length === 1) {
        context.fillText(lineText, x, y);
      } else {
        // Căn đều: Tính toán khoảng cách thêm vào giữa các từ
        const totalWordsWidth = lineWords.reduce((sum, word) => sum + context.measureText(word).width, 0);
        const extraSpace = (maxWidth - totalWordsWidth) / (lineWords.length - 1);
        
        let currentX = x;
        lineWords.forEach((word, wordIndex) => {
          context.fillText(word, currentX, y);
          currentX += context.measureText(word).width + extraSpace;
        });
      }
      y += lineHeight;
    });
  }

  function downloadImage() {
    incrementStats();
    const box = document.getElementById('statsContainer');
    box.style.transform = "scale(1.2)";
    setTimeout(() => { box.style.transform = "scale(1)"; }, 200);
    const link = document.createElement('a');
    link.download = 'Thong-diep-Dai-Hoi-XIV.jpg';
    link.href = canvas.toDataURL('image/jpeg', 1.0);
    link.click();
  }
</script>
</body>
</html>